<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生成绩波动分析器(750分制)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: url('/img/background.png') no-repeat center center fixed;
            background-size: cover;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.2em;
            position: relative;
            padding-bottom: 15px;
        }
        
        h1:after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(to right, #3498db, #9b59b6);
        }
        
        .exam-form {
            margin-bottom: 30px;
            padding: 25px;
            background-color: rgba(240, 240, 240, 0.7);
            border-radius: 12px;
            border-left: 5px solid #3498db;
        }
        
        .exam-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .subject-group {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }
        
        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.95em;
        }
        
        input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        .error {
            border-color: #e74c3c;
            background-color: #fadbd8;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.8em;
            margin-top: 5px;
            display: none;
        }
        
        .direction-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .direction-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .direction-option input {
            width: auto;
        }
        
        .add-btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .add-btn:hover {
            background-color: #2980b9;
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .remove-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .remove-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .analyze-btn {
            background: linear-gradient(to right, #3498db, #9b59b6);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 30px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            margin: 30px auto;
            font-weight: 600;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .analyze-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .results {
            margin-top: 40px;
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chart-container {
            margin-bottom: 40px;
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            position: relative;
        }
        
        .chart-container h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #f1f1f1;
            padding-bottom: 10px;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .stats-table th, .stats-table td {
            padding: 14px 18px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        .stats-table th {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
            font-weight: 600;
        }
        
        .stats-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .stats-table tr:hover {
            background-color: #eaf4fd;
        }
        
        .tab-container {
            margin-top: 40px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 0;
            background-color: #f8f9fa;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }
        
        .tab-btn {
            padding: 12px 25px;
            background-color: #e0e0e0;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 0;
            font-weight: 600;
            color: #555;
            border-right: 1px solid #d0d0d0;
        }
        
        .tab-btn:last-child {
            border-right: none;
        }
        
        .tab-btn.active {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 25px;
            background-color: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        .file-upload {
            margin: 25px 0;
            text-align: center;
        }
        
        .file-upload-btn {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .file-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .export-btn {
            background: linear-gradient(to right, #f39c12, #e67e22);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 25px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .score-summary {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .summary-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            width: 200px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
            transition: all 0.3s;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .summary-card h4 {
            margin-top: 0;
            color: #7f8c8d;
            font-size: 1em;
        }
        
        .summary-card p {
            font-size: 1.8em;
            margin: 10px 0 0;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .highlight {
            color: #e74c3c;
        }
        
        .good {
            color: #2ecc71;
        }
        
        .warning {
            color: #f39c12;
        }
        
        .subject-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .subject-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #f1f1f1;
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        .subject-checkbox input {
            width: auto;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #f8d7da;
            color: #721c24;
            border-left: 5px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>学生成绩波动分析器 (750分制)</h1>
        
        <div class="file-upload">
            <input type="file" id="multiFileInput" accept=".xlsx,.xls" multiple style="display: none;">
            <button class="file-upload-btn" onclick="document.getElementById('multiFileInput').click()">导入多个学生成绩Excel文件</button>
        </div>
        
        <div id="singleStudentSection">
            <h2>单个学生成绩录入</h2>
            <div id="examFormsContainer">
                <div class="exam-form" id="examForm1">
                    <div class="direction-selector">
                        <div class="direction-option">
                            <input type="radio" id="physicsDirection1" name="direction1" value="physics" checked>
                            <label for="physicsDirection1">物理方向</label>
                        </div>
                        <div class="direction-option">
                            <input type="radio" id="historyDirection1" name="direction1" value="history">
                            <label for="historyDirection1">历史方向</label>
                        </div>
                    </div>
                    
                    <div class="subject-selector" id="electiveSelector1">
                        <p>请选择2门选修科目：</p>
                        <div class="subject-checkbox">
                            <input type="checkbox" id="chemistry1" value="化学">
                            <label for="chemistry1">化学</label>
                        </div>
                        <div class="subject-checkbox">
                            <input type="checkbox" id="biology1" value="生物">
                            <label for="biology1">生物</label>
                        </div>
                        <div class="subject-checkbox">
                            <input type="checkbox" id="politics1" value="政治">
                            <label for="politics1">政治</label>
                        </div>
                        <div class="subject-checkbox">
                            <input type="checkbox" id="geography1" value="地理">
                            <label for="geography1">地理</label>
                        </div>
                    </div>
                    
                    <div class="exam-row">
                        <div class="subject-group">
                            <label for="examName1">考试名称</label>
                            <input type="text" id="examName1" placeholder="如：期中考试">
                        </div>
                        <div class="subject-group">
                            <label for="chinese1">语文 (150)</label>
                            <input type="number" id="chinese1" min="0" max="150" placeholder="0-150">
                            <div class="error-message" id="chineseError1"></div>
                        </div>
                        <div class="subject-group">
                            <label for="math1">数学 (150)</label>
                            <input type="number" id="math1" min="0" max="150" placeholder="0-150">
                            <div class="error-message" id="mathError1"></div>
                        </div>
                        <div class="subject-group">
                            <label for="english1">英语 (150)</label>
                            <input type="number" id="english1" min="0" max="150" placeholder="0-150">
                            <div class="error-message" id="englishError1"></div>
                        </div>
                        <div class="subject-group">
                            <label for="physics1">物理 (100)</label>
                            <input type="number" id="physics1" min="0" max="100" placeholder="0-100">
                            <div class="error-message" id="physicsError1"></div>
                        </div>
                        <div class="subject-group">
                            <label for="history1">历史 (100)</label>
                            <input type="number" id="history1" min="0" max="100" placeholder="0-100">
                            <div class="error-message" id="historyError1"></div>
                        </div>
                        <div class="subject-group">
                            <label for="chemistry1">化学 (100)</label>
                            <input type="number" id="chemistryScore1" min="0" max="100" placeholder="0-100">
                            <div class="error-message" id="chemistryError1"></div>
                        </div>
                        <div class="subject-group">
                            <label for="biology1">生物 (100)</label>
                            <input type="number" id="biologyScore1" min="0" max="100" placeholder="0-100">
                            <div class="error-message" id="biologyError1"></div>
                        </div>
                        <div class="subject-group">
                            <label for="politics1">政治 (100)</label>
                            <input type="number" id="politicsScore1" min="0" max="100" placeholder="0-100">
                            <div class="error-message" id="politicsError1"></div>
                        </div>
                        <div class="subject-group">
                            <label for="geography1">地理 (100)</label>
                            <input type="number" id="geographyScore1" min="0" max="100" placeholder="0-100">
                            <div class="error-message" id="geographyError1"></div>
                        </div>
                        <button class="add-btn" onclick="addExamForm()">+</button>
                    </div>
                </div>
            </div>
            
            <button class="analyze-btn" onclick="analyzeResults()">分析成绩</button>
        </div>
        
        <div class="results" id="results">
            <h2>分析结果</h2>
            
            <div class="score-summary" id="scoreSummary">
                <!-- 动态生成分数摘要 -->
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="openTab('stats')">统计数据</button>
                    <button class="tab-btn" onclick="openTab('trend')">趋势图表</button>
                    <button class="tab-btn" onclick="openTab('radar')">雷达图</button>
                </div>
                
                <div id="stats" class="tab-content active">
                    <h3>考试成绩统计</h3>
                    <table class="stats-table" id="statsTable">
                        <thead>
                            <tr>
                                <th>考试名称</th>
                                <th>语文</th>
                                <th>数学</th>
                                <th>英语</th>
                                <th>物理/历史</th>
                                <th>选修1</th>
                                <th>选修2</th>
                                <th>总分</th>
                                <th>排名</th>
                            </tr>
                        </thead>
                        <tbody id="statsBody">
                        </tbody>
                    </table>
                    
                    <h3>成绩波动分析（方差）</h3>
                    <table class="stats-table" id="varianceTable">
                        <thead>
                            <tr>
                                <th>科目</th>
                                <th>方差</th>
                                <th>波动分析</th>
                                <th>稳定性建议</th>
                            </tr>
                        </thead>
                        <tbody id="varianceBody">
                        </tbody>
                    </table>
                </div>
                
                <div id="trend" class="tab-content">
                    <h3>成绩变化趋势</h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                
                <div id="radar" class="tab-content">
                    <h3>成绩分布雷达图</h3>
                    <div class="chart-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>
            
            <button class="export-btn" onclick="exportToExcel()">导出到Excel</button>
        </div>
        
        <div id="multiStudentResults" style="display: none;">
            <h2>多学生分析结果</h2>
            <div id="multiStudentCharts"></div>
        </div>
    </div>

    <script>
        let examCount = 1;
        let allExams = [];
        let multiStudentData = {};
        
        // 添加考试表单
        function addExamForm() {
            examCount++;
            const container = document.getElementById('examFormsContainer');
            const newForm = document.createElement('div');
            newForm.className = 'exam-form';
            newForm.id = `examForm${examCount}`;
            
            newForm.innerHTML = `
                <div class="direction-selector">
                    <div class="direction-option">
                        <input type="radio" id="physicsDirection${examCount}" name="direction${examCount}" value="physics" checked>
                        <label for="physicsDirection${examCount}">物理方向</label>
                    </div>
                    <div class="direction-option">
                        <input type="radio" id="historyDirection${examCount}" name="direction${examCount}" value="history">
                        <label for="historyDirection${examCount}">历史方向</label>
                    </div>
                </div>
                
                <div class="subject-selector" id="electiveSelector${examCount}">
                    <p>请选择2门选修科目：</p>
                    <div class="subject-checkbox">
                        <input type="checkbox" id="chemistry${examCount}" value="化学">
                        <label for="chemistry${examCount}">化学</label>
                    </div>
                    <div class="subject-checkbox">
                        <input type="checkbox" id="biology${examCount}" value="生物">
                        <label for="biology${examCount}">生物</label>
                    </div>
                    <div class="subject-checkbox">
                        <input type="checkbox" id="politics${examCount}" value="政治">
                        <label for="politics${examCount}">政治</label>
                    </div>
                    <div class="subject-checkbox">
                        <input type="checkbox" id="geography${examCount}" value="地理">
                        <label for="geography${examCount}">地理</label>
                    </div>
                </div>
                
                <div class="exam-row">
                    <div class="subject-group">
                        <label for="examName${examCount}">考试名称</label>
                        <input type="text" id="examName${examCount}" placeholder="如：期中考试">
                    </div>
                    <div class="subject-group">
                        <label for="chinese${examCount}">语文 (150)</label>
                        <input type="number" id="chinese${examCount}" min="0" max="150" placeholder="0-150">
                        <div class="error-message" id="chineseError${examCount}"></div>
                    </div>
                    <div class="subject-group">
                        <label for="math${examCount}">数学 (150)</label>
                        <input type="number" id="math${examCount}" min="0" max="150" placeholder="0-150">
                        <div class="error-message" id="mathError${examCount}"></div>
                    </div>
                    <div class="subject-group">
                        <label for="english${examCount}">英语 (150)</label>
                        <input type="number" id="english${examCount}" min="0" max="150" placeholder="0-150">
                        <div class="error-message" id="englishError${examCount}"></div>
                    </div>
                    <div class="subject-group">
                        <label for="physics${examCount}">物理 (100)</label>
                        <input type="number" id="physics${examCount}" min="0" max="100" placeholder="0-100">
                        <div class="error-message" id="physicsError${examCount}"></div>
                    </div>
                    <div class="subject-group">
                        <label for="history${examCount}">历史 (100)</label>
                        <input type="number" id="history${examCount}" min="0" max="100" placeholder="0-100">
                        <div class="error-message" id="historyError${examCount}"></div>
                    </div>
                    <div class="subject-group">
                        <label for="chemistry${examCount}">化学 (100)</label>
                        <input type="number" id="chemistryScore${examCount}" min="0" max="100" placeholder="0-100">
                        <div class="error-message" id="chemistryError${examCount}"></div>
                    </div>
                    <div class="subject-group">
                        <label for="biology${examCount}">生物 (100)</label>
                        <input type="number" id="biologyScore${examCount}" min="0" max="100" placeholder="0-100">
                        <div class="error-message" id="biologyError${examCount}"></div>
                    </div>
                    <div class="subject-group">
                        <label for="politics${examCount}">政治 (100)</label>
                        <input type="number" id="politicsScore${examCount}" min="0" max="100" placeholder="0-100">
                        <div class="error-message" id="politicsError${examCount}"></div>
                    </div>
                    <div class="subject-group">
                        <label for="geography${examCount}">地理 (100)</label>
                        <input type="number" id="geographyScore${examCount}" min="0" max="100" placeholder="0-100">
                        <div class="error-message" id="geographyError${examCount}"></div>
                    </div>
                    <button class="remove-btn" onclick="removeExamForm(${examCount})">删除</button>
                </div>
            `;
            
            container.appendChild(newForm);
            
            // 添加复选框限制逻辑
            const checkboxes = newForm.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedCount = Array.from(checkboxes).filter(c => c.checked).length;
                    if (checkedCount > 2) {
                        this.checked = false;
                    }
                });
            });
        }
        
        // 删除考试表单
        function removeExamForm(id) {
            const form = document.getElementById(`examForm${id}`);
            if (form && examCount > 1) {
                form.remove();
                examCount--;
            }
        }
        
        // 验证输入
        function validateInputs() {
            let isValid = true;
            
            for (let i = 1; i <= examCount; i++) {
                const form = document.getElementById(`examForm${i}`);
                if (!form) continue;
                
                // 验证必选科目
                const chinese = document.getElementById(`chinese${i}`);
                const math = document.getElementById(`math${i}`);
                const english = document.getElementById(`english${i}`);
                
                // 验证选考科目
                const physics = document.getElementById(`physics${i}`);
                const history = document.getElementById(`history${i}`);
                const chemistry = document.getElementById(`chemistryScore${i}`);
                const biology = document.getElementById(`biologyScore${i}`);
                const politics = document.getElementById(`politicsScore${i}`);
                const geography = document.getElementById(`geographyScore${i}`);
                
                // 重置错误状态
                [chinese, math, english, physics, history, chemistry, biology, politics, geography].forEach(input => {
                    if (input) {
                        input.classList.remove('error');
                        const errorMsg = document.getElementById(`${input.id}Error${i}`);
                        if (errorMsg) errorMsg.style.display = 'none';
                    }
                });
                
                // 验证必选科目
                if (chinese && (chinese.value === '' || chinese.value < 0 || chinese.value > 150)) {
                    chinese.classList.add('error');
                    document.getElementById(`chineseError${i}`).textContent = '请输入0-150之间的分数';
                    document.getElementById(`chineseError${i}`).style.display = 'block';
                    isValid = false;
                }
                
                if (math && (math.value === '' || math.value < 0 || math.value > 150)) {
                    math.classList.add('error');
                    document.getElementById(`mathError${i}`).textContent = '请输入0-150之间的分数';
                    document.getElementById(`mathError${i}`).style.display = 'block';
                    isValid = false;
                }
                
                if (english && (english.value === '' || english.value < 0 || english.value > 150)) {
                    english.classList.add('error');
                    document.getElementById(`englishError${i}`).textContent = '请输入0-150之间的分数';
                    document.getElementById(`englishError${i}`).style.display = 'block';
                    isValid = false;
                }
                
                // 检查选修科目
                const direction = document.querySelector(`input[name="direction${i}"]:checked`).value;
                const electiveCheckboxes = document.querySelectorAll(`#electiveSelector${i} input[type="checkbox"]:checked`);
                
                if (electiveCheckboxes.length !== 2) {
                    alert(`第${i}次考试: 请选择2门选修科目`);
                    isValid = false;
                }
                
                // 验证主科
                if (direction === 'physics') {
                    if (physics && (physics.value === '' || physics.value < 0 || physics.value > 100)) {
                        physics.classList.add('error');
                        document.getElementById(`physicsError${i}`).textContent = '请输入0-100之间的分数';
                        document.getElementById(`physicsError${i}`).style.display = 'block';
                        isValid = false;
                    }
                } else {
                    if (history && (history.value === '' || history.value < 0 || history.value > 100)) {
                        history.classList.add('error');
                        document.getElementById(`historyError${i}`).textContent = '请输入0-100之间的分数';
                        document.getElementById(`historyError${i}`).style.display = 'block';
                        isValid = false;
                    }
                }
                
                // 验证选修科目
                electiveCheckboxes.forEach(checkbox => {
                    const subject = checkbox.value;
                    const inputId = `${subject.toLowerCase()}Score${i}`;
                    const input = document.getElementById(inputId);
                    
                    if (input && (input.value === '' || input.value < 0 || input.value > 100)) {
                        input.classList.add('error');
                        document.getElementById(`${inputId}Error${i}`).textContent = '请输入0-100之间的分数';
                        document.getElementById(`${inputId}Error${i}`).style.display = 'block';
                        isValid = false;
                    }
                });
            }
            
            return isValid;
        }
        
        // 收集考试数据
        function collectExamData() {
            allExams = [];
            
            for (let i = 1; i <= examCount; i++) {
                const form = document.getElementById(`examForm${i}`);
                if (!form) continue;
                
                const examName = document.getElementById(`examName${i}`).value || `考试${i}`;
                const chinese = parseFloat(document.getElementById(`chinese${i}`).value) || 0;
                const math = parseFloat(document.getElementById(`math${i}`).value) || 0;
                const english = parseFloat(document.getElementById(`english${i}`).value) || 0;
                
                const direction = document.querySelector(`input[name="direction${i}"]:checked`).value;
                const electiveCheckboxes = document.querySelectorAll(`#electiveSelector${i} input[type="checkbox"]:checked`);
                const electiveSubjects = Array.from(electiveCheckboxes).map(cb => cb.value);
                
                const physics = direction === 'physics' ? (parseFloat(document.getElementById(`physics${i}`).value) || 0) : null;
                const history = direction === 'history' ? (parseFloat(document.getElementById(`history${i}`).value) || 0) : null;
                
                // 获取选修科目分数
                let chemistry = null, biology = null, politics = null, geography = null;
                electiveSubjects.forEach(subject => {
                    const scoreInput = document.getElementById(`${subject.toLowerCase()}Score${i}`);
                    if (subject === '化学') chemistry = parseFloat(scoreInput.value) || 0;
                    if (subject === '生物') biology = parseFloat(scoreInput.value) || 0;
                    if (subject === '政治') politics = parseFloat(scoreInput.value) || 0;
                    if (subject === '地理') geography = parseFloat(scoreInput.value) || 0;
                });
                
                // 计算总分
                const mainSubject = direction === 'physics' ? physics : history;
                const elective1 = electiveSubjects[0] === '化学' ? chemistry : 
                                 electiveSubjects[0] === '生物' ? biology : 
                                 electiveSubjects[0] === '政治' ? politics : geography;
                const elective2 = electiveSubjects[1] === '化学' ? chemistry : 
                                 electiveSubjects[1] === '生物' ? biology : 
                                 electiveSubjects[1] === '政治' ? politics : geography;
                
                const totalScore = chinese + math + english + mainSubject + elective1 + elective2;
                
                allExams.push({
                    examName,
                    direction,
                    electiveSubjects,
                    chinese,
                    math,
                    english,
                    physics,
                    history,
                    chemistry,
                    biology,
                    politics,
                    geography,
                    mainSubject,
                    elective1,
                    elective2,
                    totalScore
                });
            }
            
            // 计算排名
            calculateRankings();
        }
        
        // 计算排名
        function calculateRankings() {
            // 按总分排序
            const sortedExams = [...allExams].sort((a, b) => b.totalScore - a.totalScore);
            
            // 添加排名信息
            allExams.forEach(exam => {
                const rank = sortedExams.findIndex(e => e.examName === exam.examName) + 1;
                exam.rank = rank;
                exam.percentile = ((allExams.length - rank) / allExams.length * 100).toFixed(1);
            });
        }
        
        // 计算方差
        function calculateVariance(scores) {
            if (scores.length < 2) return 0;
            
            const mean = scores.reduce((a, b) => a + b, 0) / scores.length;
            return scores.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / scores.length;
        }
        
        // 分析波动情况
        function analyzeFluctuation(variance, subject) {
            const thresholds = {
                'chinese': [100, 200],
                'math': [150, 300],
                'english': [100, 200],
                'physics': [60, 120],
                'history': [60, 120],
                'chemistry': [60, 120],
                'biology': [60, 120],
                'politics': [60, 120],
                'geography': [60, 120],
                'default': [80, 160]
            };
            
            const threshold = thresholds[subject] || thresholds['default'];
            
            if (variance < threshold[0]) return '成绩稳定';
            if (variance < threshold[1]) return '成绩有一定波动';
            return '成绩波动较大';
        }
        
        // 获取稳定性建议
        function getStabilityAdvice(subject, variance) {
            const adviceMap = {
                'chinese': {
                    low: '语文成绩稳定，继续保持阅读和写作练习',
                    medium: '语文成绩有波动，建议加强薄弱题型训练',
                    high: '语文成绩波动大，需要系统分析问题所在'
                },
                'math': {
                    low: '数学成绩稳定，继续保持解题训练',
                    medium: '数学成绩有波动，建议加强易错题分析',
                    high: '数学成绩波动大，需要查漏补缺'
                },
                'english': {
                    low: '英语成绩稳定，保持词汇积累和阅读',
                    medium: '英语成绩有波动，加强听力和写作训练',
                    high: '英语成绩波动大，需系统复习语法和词汇'
                },
                'default': {
                    low: '成绩稳定，继续保持',
                    medium: '成绩有一定波动，建议加强复习',
                    high: '成绩波动大，需要重点分析原因'
                }
            };
            
            const thresholds = {
                'chinese': [100, 200],
                'math': [150, 300],
                'english': [100, 200],
                'default': [80, 160]
            };
            
            const threshold = thresholds[subject] || thresholds['default'];
            const advice = adviceMap[subject] || adviceMap['default'];
            
            if (variance < threshold[0]) return advice.low;
            if (variance < threshold[1]) return advice.medium;
            return advice.high;
        }
        
        // 显示分数摘要
        function displayScoreSummary() {
            const summaryContainer = document.getElementById('scoreSummary');
            summaryContainer.innerHTML = '';
            
            if (allExams.length === 0) return;
            
            // 最高分
            const maxScore = Math.max(...allExams.map(exam => exam.totalScore));
            // 最低分
            const minScore = Math.min(...allExams.map(exam => exam.totalScore));
            // 平均分
            const avgScore = allExams.reduce((sum, exam) => sum + exam.totalScore, 0) / allExams.length;
            // 最新考试分数
            const latestExam = allExams[allExams.length - 1];
            
            const summaries = [
                { title: '最高分', value: maxScore, class: maxScore >= 650 ? 'good' : '' },
                { title: '最低分', value: minScore, class: minScore < 450 ? 'highlight' : '' },
                { title: '平均分', value: avgScore.toFixed(1), class: '' },
                { title: '最近一次', value: latestExam.totalScore, 
                  class: latestExam.totalScore < avgScore ? 'highlight' : 
                        latestExam.totalScore > avgScore ? 'good' : '' },
                { title: '最好排名', value: Math.min(...allExams.map(exam => exam.rank)), class: '' },
                { title: '排名变化', value: allExams.length > 1 ? 
                  `${allExams[0].rank} → ${latestExam.rank}` : latestExam.rank, 
                  class: allExams.length > 1 && latestExam.rank < allExams[0].rank ? 'good' : 
                        allExams.length > 1 && latestExam.rank > allExams[0].rank ? 'highlight' : '' }
            ];
            
            summaries.forEach(summary => {
                const card = document.createElement('div');
                card.className = `summary-card ${summary.class}`;
                card.innerHTML = `
                    <h4>${summary.title}</h4>
                    <p>${summary.value}</p>
                `;
                summaryContainer.appendChild(card);
            });
        }
        
        // 显示分析结果
        function displayResults() {
            // 显示分数摘要
            displayScoreSummary();
            
            // 显示考试成绩表格
            const statsBody = document.getElementById('statsBody');
            statsBody.innerHTML = '';
            
            allExams.forEach(exam => {
                const row = document.createElement('tr');
                
                // 确定选修科目名称
                const elective1Name = exam.electiveSubjects[0];
                const elective2Name = exam.electiveSubjects[1];
                const elective1Score = elective1Name === '化学' ? exam.chemistry : 
                                      elective1Name === '生物' ? exam.biology : 
                                      elective1Name === '政治' ? exam.politics : exam.geography;
                const elective2Score = elective2Name === '化学' ? exam.chemistry : 
                                      elective2Name === '生物' ? exam.biology : 
                                      elective2Name === '政治' ? exam.politics : exam.geography;
                
                row.innerHTML = `
                    <td>${exam.examName}</td>
                    <td>${exam.chinese}</td>
                    <td>${exam.math}</td>
                    <td>${exam.english}</td>
                    <td>${exam.direction === 'physics' ? exam.physics : exam.history}</td>
                    <td>${elective1Name}: ${elective1Score}</td>
                    <td>${elective2Name}: ${elective2Score}</td>
                    <td>${exam.totalScore}</td>
                    <td>${exam.rank} (前${exam.percentile}%)</td>
                `;
                statsBody.appendChild(row);
            });
            
            // 计算并显示方差
            const varianceBody = document.getElementById('varianceBody');
            varianceBody.innerHTML = '';
            
            const coreSubjects = ['chinese', 'math', 'english'];
            const directionSubject = allExams[0].direction === 'physics' ? 'physics' : 'history';
            const electiveSubjects = allExams[0].electiveSubjects.map(sub => sub.toLowerCase());
            const allSubjects = [...coreSubjects, directionSubject, ...electiveSubjects];
            
            allSubjects.forEach(subject => {
                const scores = allExams.map(exam => exam[subject]);
                const variance = calculateVariance(scores);
                const fluctuation = analyzeFluctuation(variance, subject);
                const advice = getStabilityAdvice(subject, variance);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${getSubjectName(subject)}</td>
                    <td>${variance.toFixed(2)}</td>
                    <td>${fluctuation}</td>
                    <td>${advice}</td>
                `;
                varianceBody.appendChild(row);
            });
            
            // 创建趋势图表
            createTrendChart();
            
            // 创建雷达图
            createRadarChart();
            
            // 显示结果区域
            document.getElementById('results').style.display = 'block';
        }
        
        // 获取科目中文名称
        function getSubjectName(subject) {
            const names = {
                'chinese': '语文',
                'math': '数学',
                'english': '英语',
                'physics': '物理',
                'history': '历史',
                'chemistry': '化学',
                'biology': '生物',
                'politics': '政治',
                'geography': '地理'
            };
            return names[subject] || subject;
        }
        
        // 创建趋势图表
        function createTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // 收集所有科目
            const coreSubjects = ['chinese', 'math', 'english'];
            const directionSubject = allExams[0].direction === 'physics' ? 'physics' : 'history';
            const electiveSubjects = allExams[0].electiveSubjects.map(sub => sub.toLowerCase());
            const allSubjects = [...coreSubjects, directionSubject, ...electiveSubjects];
            
            const datasets = allSubjects.map(subject => {
                return {
                    label: getSubjectName(subject),
                    data: allExams.map(exam => exam[subject]),
                    borderWidth: 2,
                    fill: false
                };
            });
            
            // 添加总分曲线
            datasets.push({
                label: '总分',
                data: allExams.map(exam => exam.totalScore),
                borderWidth: 3,
                borderColor: '#000000',
                fill: false,
                borderDash: [5, 5]
            });
            
            if (window.trendChart) {
                window.trendChart.destroy();
            }
            
            window.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allExams.map(exam => exam.examName),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: Math.max(0, Math.min(...allExams.map(exam => {
                                const minSubject = Math.min(
                                    exam.chinese, 
                                    exam.math, 
                                    exam.english, 
                                    exam.direction === 'physics' ? exam.physics : exam.history,
                                    ...exam.electiveSubjects.map(sub => {
                                        return sub === '化学' ? exam.chemistry : 
                                               sub === '生物' ? exam.biology : 
                                               sub === '政治' ? exam.politics : exam.geography;
                                    })
                                );
                                return minSubject - 20;
                            })),
                            max: 750
                        }
                    }
                }
            });
        }
        
        // 创建雷达图
        function createRadarChart() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            // 只显示最后一次考试的成绩
            const lastExam = allExams[allExams.length - 1];
            const coreSubjects = ['chinese', 'math', 'english'];
            const directionSubject = lastExam.direction === 'physics' ? 'physics' : 'history';
            const electiveSubjects = lastExam.electiveSubjects.map(sub => sub.toLowerCase());
            const allSubjects = [...coreSubjects, directionSubject, ...electiveSubjects];
            
            const data = {
                labels: allSubjects.map(getSubjectName),
                datasets: [{
                    label: lastExam.examName,
                    data: allSubjects.map(subject => lastExam[subject]),
                    fill: true,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgb(54, 162, 235)',
                    pointBackgroundColor: 'rgb(54, 162, 235)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(54, 162, 235)'
                }]
            };
            
            if (window.radarChart) {
                window.radarChart.destroy();
            }
            
            window.radarChart = new Chart(ctx, {
                type: 'radar',
                data: data,
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 150
                        }
                    }
                }
            });
        }
        
        // 打开标签页
        function openTab(tabId) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            const tabButtons = document.getElementsByClassName('tab-btn');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        // 导出到Excel
        function exportToExcel() {
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 创建考试成绩表
            const examData = [
                ['考试名称', '方向', '语文', '数学', '英语', '物理/历史', 
                 '选修1科目', '选修1分数', '选修2科目', '选修2分数', '总分', '排名', '百分比'],
                ...allExams.map(exam => {
                    const elective1Name = exam.electiveSubjects[0];
                    const elective2Name = exam.electiveSubjects[1];
                    const elective1Score = elective1Name === '化学' ? exam.chemistry : 
                                          elective1Name === '生物' ? exam.biology : 
                                          elective1Name === '政治' ? exam.politics : exam.geography;
                    const elective2Score = elective2Name === '化学' ? exam.chemistry : 
                                          elective2Name === '生物' ? exam.biology : 
                                          elective2Name === '政治' ? exam.politics : exam.geography;
                    
                    return [
                        exam.examName,
                        exam.direction === 'physics' ? '物理' : '历史',
                        exam.chinese,
                        exam.math,
                        exam.english,
                        exam.direction === 'physics' ? exam.physics : exam.history,
                        elective1Name,
                        elective1Score,
                        elective2Name,
                        elective2Score,
                        exam.totalScore,
                        exam.rank,
                        exam.percentile + '%'
                    ];
                })
            ];
            
            const examWs = XLSX.utils.aoa_to_sheet(examData);
            XLSX.utils.book_append_sheet(wb, examWs, '考试成绩');
            
            // 创建方差分析表
            const coreSubjects = ['chinese', 'math', 'english'];
            const directionSubject = allExams[0].direction === 'physics' ? 'physics' : 'history';
            const electiveSubjects = allExams[0].electiveSubjects.map(sub => sub.toLowerCase());
            const allSubjects = [...coreSubjects, directionSubject, ...electiveSubjects];
            
            const varianceData = [['科目', '方差', '波动分析', '稳定性建议']];
            
            allSubjects.forEach(subject => {
                const scores = allExams.map(exam => exam[subject]);
                const variance = calculateVariance(scores);
                const fluctuation = analyzeFluctuation(variance, subject);
                const advice = getStabilityAdvice(subject, variance);
                
                varianceData.push([
                    getSubjectName(subject),
                    variance.toFixed(2),
                    fluctuation,
                    advice
                ]);
            });
            
            const varianceWs = XLSX.utils.aoa_to_sheet(varianceData);
            XLSX.utils.book_append_sheet(wb, varianceWs, '方差分析');
            
            // 导出工作簿
            XLSX.writeFile(wb, '成绩分析报告.xlsx');
        }
        
        // 分析多学生数据
        function analyzeMultiStudentData(files) {
            document.getElementById('singleStudentSection').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.getElementById('multiStudentResults').style.display = 'block';
            
            const chartsContainer = document.getElementById('multiStudentCharts');
            chartsContainer.innerHTML = '<h3>正在分析数据，请稍候...</h3>';
            
            multiStudentData = {};
            
            let filesProcessed = 0;
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 假设每个文件的第一张表是成绩数据
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // 提取学生姓名（假设第一行是标题，第二行开始是数据）
                    const studentName = file.name.replace('.xlsx', '').replace('.xls', '');
                    multiStudentData[studentName] = jsonData;
                    
                    filesProcessed++;
                    
                    if (filesProcessed === files.length) {
                        renderMultiStudentCharts();
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        // 渲染多学生图表
        function renderMultiStudentCharts() {
            const container = document.getElementById('multiStudentCharts');
            container.innerHTML = '';
            
            // 为每个学生创建图表
            Object.keys(multiStudentData).forEach(studentName => {
                const studentData = multiStudentData[studentName];
                
                // 创建学生卡片
                const studentCard = document.createElement('div');
                studentCard.className = 'exam-form';
                studentCard.innerHTML = `<h3>${studentName}</h3>`;
                
                // 创建趋势图表容器
                const trendCanvas = document.createElement('canvas');
                trendCanvas.id = `trendChart_${studentName}`;
                studentCard.appendChild(trendCanvas);
                
                // 创建雷达图容器
                const radarCanvas = document.createElement('canvas');
                radarCanvas.id = `radarChart_${studentName}`;
                studentCard.appendChild(radarCanvas);
                
                container.appendChild(studentCard);
                
                // 渲染趋势图
                renderStudentTrendChart(studentName, studentData);
                
                // 渲染雷达图
                renderStudentRadarChart(studentName, studentData);
            });
            
            // 添加导出按钮
            const exportBtn = document.createElement('button');
            exportBtn.className = 'export-btn';
            exportBtn.textContent = '导出所有学生数据到Excel';
            exportBtn.onclick = exportAllStudentsToExcel;
            container.appendChild(exportBtn);
        }
        
        // 渲染学生趋势图
        function renderStudentTrendChart(studentName, studentData) {
            const ctx = document.getElementById(`trendChart_${studentName}`).getContext('2d');
            
            // 收集所有考试名称
            const examNames = studentData.map(exam => exam['考试名称'] || exam['examName'] || '未命名考试');
            
            // 收集所有科目
            const coreSubjects = ['语文', '数学', '英语'];
            const directionSubject = studentData[0]['方向'] === 'physics' ? '物理' : '历史';
            const electiveSubjects = [studentData[0]['选修1科目'], studentData[0]['选修2科目']];
            const allSubjects = [...coreSubjects, directionSubject, ...electiveSubjects];
            
            const datasets = allSubjects.map(subject => {
                return {
                    label: subject,
                    data: studentData.map(exam => exam[subject]),
                    borderWidth: 2,
                    fill: false
                };
            });
            
            // 添加总分曲线
            datasets.push({
                label: '总分',
                data: studentData.map(exam => exam['总分']),
                borderWidth: 3,
                borderColor: '#000000',
                fill: false,
                borderDash: [5, 5]
            });
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: examNames,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: Math.max(0, Math.min(...studentData.map(exam => {
                                const minSubject = Math.min(
                                    exam['语文'], 
                                    exam['数学'], 
                                    exam['英语'], 
                                    exam[directionSubject],
                                    exam[electiveSubjects[0]],
                                    exam[electiveSubjects[1]]
                                );
                                return minSubject - 20;
                            })),
                            max: 750
                        }
                    }
                }
            });
        }
        
        // 渲染学生雷达图
        function renderStudentRadarChart(studentName, studentData) {
            const ctx = document.getElementById(`radarChart_${studentName}`).getContext('2d');
            
            // 只显示最后一次考试的成绩
            const lastExam = studentData[studentData.length - 1];
            const coreSubjects = ['语文', '数学', '英语'];
            const directionSubject = lastExam['方向'] === 'physics' ? '物理' : '历史';
            const electiveSubjects = [lastExam['选修1科目'], lastExam['选修2科目']];
            const allSubjects = [...coreSubjects, directionSubject, ...electiveSubjects];
            
            const data = {
                labels: allSubjects,
                datasets: [{
                    label: lastExam['考试名称'] || lastExam['examName'] || '最后一次考试',
                    data: allSubjects.map(subject => lastExam[subject]),
                    fill: true,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgb(54, 162, 235)',
                    pointBackgroundColor: 'rgb(54, 162, 235)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(54, 162, 235)'
                }]
            };
            
            new Chart(ctx, {
                type: 'radar',
                data: data,
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 150
                        }
                    }
                }
            });
        }
        
        // 导出所有学生数据到Excel
        function exportAllStudentsToExcel() {
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 为每个学生创建工作表
            Object.keys(multiStudentData).forEach(studentName => {
                const studentData = multiStudentData[studentName];
                
                // 创建表头
                const headers = Object.keys(studentData[0]);
                const data = [
                    headers,
                    ...studentData.map(exam => headers.map(header => exam[header]))
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, studentName.substring(0, 31)); // 限制工作表名称长度
            });
            
            // 导出工作簿
            XLSX.writeFile(wb, '多学生成绩分析报告.xlsx');
        }
        
        // 主分析函数
        function analyzeResults() {
            if (!validateInputs()) {
                alert('请检查输入数据是否正确！');
                return;
            }
            
            collectExamData();
            displayResults();
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 添加复选框限制逻辑
            const checkboxes = document.querySelectorAll('#electiveSelector1 input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedCount = Array.from(checkboxes).filter(c => c.checked).length;
                    if (checkedCount > 2) {
                        this.checked = false;
                    }
                });
            });
            
            // 多文件上传处理
            document.getElementById('multiFileInput').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    analyzeMultiStudentData(e.target.files);
                }
            });
        });
    </script>
</body>
</html>